<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:s="http://www.springframework.org/schema/security"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/security
	   http://www.springframework.org/schema/security/spring-security.xsd">

    <s:global-method-security secured-annotations="enabled"/>
    <!--<s:global-method-security pre-post-annotations="enabled" />-->

    <s:http auto-config="true">
        <s:intercept-url pattern="/admin/*" access="hasRole('ADMIN')"/>
        <s:intercept-url pattern="/cart/order" access="hasRole('USER')"/>
        <!--<s:intercept-url pattern="/registration" access="isAnonymous()"/>-->
        <!--<s:intercept-url pattern="/registration" access="isAnonymous()" method="POST"/>-->
        <s:intercept-url pattern="/login" access="isAnonymous()"/>
        <s:form-login
                login-page="/login"
                username-parameter="login"
                password-parameter="password"
                authentication-failure-url="/login?error"
                login-processing-url="/login"
                authentication-success-handler-ref="roleBasedAuthenticationSuccessHandler"
        />
        <s:logout logout-success-url="/catalog"/>
        <s:remember-me/>
        <s:csrf/>
    </s:http>

    <bean id="roleBasedAuthenticationSuccessHandler"
          class="main.controllers.handlers.AuthentificationHandler"/>

    <!--<bean name="bcryptEncoder"  //TODO  -->
    <!--class="org.springframework.s.crypto.bcrypt.BCryptPasswordEncoder"/>-->

    <s:jdbc-user-service data-source-ref="dataSource"

                         users-by-username-query="
         SELECT userName, password, CASE enabled WHEN 0 THEN FALSE ELSE TRUE END 'enabled'
         FROM `users`
         WHERE userName=?;"

                         authorities-by-username-query="
        SELECT u.userName, r.roles
        FROM users u, user_roles r
        WHERE u.userName=?
        AND u.userName=r.login;"

    />

</beans>